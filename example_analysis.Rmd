---
title: "Example analysis"
output: html_vignette
---


```{r library}
library(laminr)
db <- connect()
db$track("H6pK9lWJeie00001", path = "example_analysis.Rmd")
```

## Download a dataset from CELLxGENE

```{r connect-cellxgene}
cellxgene <- connect("laminlabs/cellxgene")
adata <- cellxgene$Artifact$get("7dVluLROpalzEh8mNyxk")$load()
```

## Marker analysis with Seurat

Create a Seurat object

```{r create-seurat}
seurat <- SeuratObject::CreateSeuratObject(
  counts = as(Matrix::t(adata$X), "CsparseMatrix"),
  meta.data = adata$obs,
)
SeuratObject::Idents(seurat) <- "Cell_Type"
```

Normalise the data

```{r normalise}
seurat <- Seurat::NormalizeData(seurat)
```


Test for marker genes

```{r find-markers}
markers <- Seurat::FindAllMarkers(
  seurat,
  features = SeuratObject::Features(seurat)[1:100] # Only test a few features for speed
)

knitr::kable(markers)
```

Plot the marker genes

```{r plot-marker}
Seurat::DotPlot(seurat, features = unique(markers$gene)) +
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, vjust = 0.5))
```

## Store for later use

```{r save-results}
db$Artifact$from_df(
  markers,
  description = "Marker genes for renal cell carcinoma dataset"
)$save()

seurat_path <- tempfile(fileext = ".rds")
saveRDS(seurat, seurat_path)
db$Artifact$from_path(
  seurat_path,
  description = "Seurat object for renal cell carcinoma dataset"
)$save()
```

# Stop tracking

When we are done we end the tracking run.

```{r finish}
db$finish()
```
